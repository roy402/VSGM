import os
import sys
sys.path.append(os.path.join(os.environ['ALFRED_ROOT']))
sys.path.append(os.path.join(os.environ['ALFRED_ROOT'], 'models'))

import torch
import os
from PIL import Image
from nn.resnet import Resnet
from argparse import ArgumentDefaultsHelpFormatter, ArgumentParser
import glob
import random

TASK_TYPES = {"1": "pick_and_place",
              "2": "look_at_obj_in_light",
              "3": "pick_clean_then_place_in_recep",
              "4": "pick_heat_then_place_in_recep",
              "5": "pick_cool_then_place_in_recep",
              "6": "pick_two_obj_and_place"}

def check_task_type_in(root, task_types):
    for task_type in task_types:
        if task_type in root:
            return True
    return False

def load_sgg(args):
    sys.path.insert(0, os.path.join(os.environ['ALFWORLD_ROOT'], 'agents', 'sgg'))
    from alfred_data_format import get_dataset, get_sgg_model
    sys.path.insert(0, os.environ['GRAPH_RCNN_ROOT'])
    from lib.config import cfg
    cfg.merge_from_file(args.sgg_config_file)
    alfred_dataset = get_dataset(cfg)
    extractor = get_sgg_model({"sgg_cfg": cfg}, alfred_dataset.trans_meta_data)
    return extractor

if __name__ == '__main__':
    parser = ArgumentParser(formatter_class=ArgumentDefaultsHelpFormatter)

    # settings
    parser.add_argument('--data', help='data folder', default='data/2.1.0')
    parser.add_argument('--batch', help='batch size', default=256, type=int)
    parser.add_argument('--gpu', help='use gpu', action='store_true')
    parser.add_argument('--skip_existing', help='skip folders that already have feats', action='store_true')
    parser.add_argument('--visual_model', default='resnet18', help='model type: maskrcnn or resnet18', choices=['maskrcnn', 'resnet18', 'sgg'])
    parser.add_argument('--keyname', help='keyname of feat', default='feat_conv')
    parser.add_argument('--str_save_ft_name', help='str_save_ft_name', default='')
    parser.add_argument('--img_folder', help='folder containing raw images', default='raw_images')
    parser.add_argument("--sgg_config_file", default=None, help="path to config file")
    parser.add_argument('--task_types', type=str, help="task_types", default="1,2,3,4,5,6")
    # parser
    args = parser.parse_args()

    task_types = []
    for tt_id in args.task_types.split(','):
        if tt_id in TASK_TYPES:
            task_types.append(TASK_TYPES[tt_id])

    if args.str_save_ft_name == "":
        raise "str_save_ft_name must have xxxx.pt"
    print(args.str_save_ft_name)
    # load resnet model
    if args.gpu:
        device = "cuda"
    else:
        device = "cpu"
    if args.visual_model == "sgg":
        extractor = load_sgg(args)
    else:
        extractor = Resnet(args, device, eval=True)
    skipped = []
    main_search_img_folder = args.img_folder.split(',')[0]
    roots = []
    '''
    beskip = ['/train/pick_and_place_with_movable_recep-ButterKnife-Cup-CounterTop-1/trial_T20190909_084351_209134/', '/train/pick_heat_then_place_in_recep-Egg-None-CounterTop-8/trial_T20190907_065242_490083/', '/train/pick_clean_then_place_in_recep-Pan-None-StoveBurner-13/trial_T20190907_124141_480086/', '/train/pick_cool_then_place_in_recep-BreadSliced-None-CounterTop-13/trial_T20190907_203133_916448/', '/train/pick_two_obj_and_place-Candle-None-Drawer-409/trial_T20190909_060303_838571/', '/train/pick_cool_then_place_in_recep-Lettuce-None-DiningTable-27/trial_T20190907_175045_014819/', '/train/pick_and_place_with_movable_recep-CreditCard-Box-SideTable-205/trial_T20190912_004956_443783/', '/train/pick_cool_then_place_in_recep-Mug-None-CoffeeMachine-11/trial_T20190908_021916_317022/', '/train/pick_clean_then_place_in_recep-TomatoSliced-None-Fridge-1/trial_T20190907_163648_570430/', '/train/pick_clean_then_place_in_recep-Pan-None-StoveBurner-2/trial_T20190909_052052_434558/', '/train/pick_cool_then_place_in_recep-Potato-None-GarbageCan-6/trial_T20190907_164610_584345/', '/train/pick_and_place_with_movable_recep-Pen-Mug-Shelf-303/trial_T20190908_141450_506574/', '/train/pick_two_obj_and_place-SoapBottle-None-Cart-401/trial_T20190908_215242_345375/', '/train/pick_two_obj_and_place-SoapBar-None-GarbageCan-420/trial_T20190908_143343_213116/', '/train/pick_heat_then_place_in_recep-Cup-None-SideTable-3/trial_T20190908_210949_409950/', '/train/pick_cool_then_place_in_recep-Cup-None-Microwave-14/trial_T20190908_093136_618867/', '/train/pick_two_obj_and_place-ToiletPaper-None-Cabinet-402/trial_T20190911_202322_415136/', '/train/pick_two_obj_and_place-SaltShaker-None-SideTable-21/trial_T20190909_041626_844806/', '/train/pick_two_obj_and_place-Candle-None-Drawer-426/trial_T20190907_133551_259209/', '/train/pick_and_place_with_movable_recep-LettuceSliced-Pot-CounterTop-17/trial_T20190909_051014_277741/', '/train/pick_two_obj_and_place-Lettuce-None-Fridge-1/trial_T20190918_212722_569040/', '/train/pick_heat_then_place_in_recep-PotatoSliced-None-CounterTop-18/trial_T20190907_041235_349093/', '/train/pick_two_obj_and_place-Vase-None-SideTable-224/trial_T20190908_013803_041895/', '/train/look_at_obj_in_light-CreditCard-None-FloorLamp-216/trial_T20190907_160557_380697/', '/train/pick_and_place_with_movable_recep-Pencil-Bowl-CounterTop-311/trial_T20190906_182005_438932/', '/train/pick_clean_then_place_in_recep-Spatula-None-CounterTop-30/trial_T20190909_050651_623153/', '/train/pick_heat_then_place_in_recep-Egg-None-Fridge-13/trial_T20190907_151643_465634/', '/train/look_at_obj_in_light-Cloth-None-DeskLamp-317/trial_T20190906_194104_882784/', '/train/pick_and_place_with_movable_recep-DishSponge-Pan-DiningTable-15/trial_T20190907_043900_185912/', '/train/pick_and_place_simple-ToiletPaper-None-ToiletPaperHanger-430/trial_T20190908_102028_194585/', '/train/look_at_obj_in_light-RemoteControl-None-FloorLamp-204/trial_T20190907_122645_093804/', '/valid_seen/pick_clean_then_place_in_recep-Ladle-None-CounterTop-14/trial_T20190909_113844_191747/', '/train/pick_heat_then_place_in_recep-BreadSliced-None-GarbageCan-12/trial_T20190907_120947_947901/', '/train/pick_and_place_with_movable_recep-Pen-Mug-SideTable-328/trial_T20190909_145028_554600/', '/train/pick_and_place_with_movable_recep-CellPhone-Box-Sofa-218/trial_T20190906_195517_392225/', '/train/pick_and_place_simple-Plate-None-Dresser-218/trial_T20190907_013614_368009/', '/train/pick_and_place_with_movable_recep-PotatoSliced-Pot-DiningTable-28/trial_T20190910_011942_129084/', '/train/pick_and_place_simple-ToiletPaper-None-ToiletPaperHanger-417/trial_T20190908_185320_708158/', '/train/pick_two_obj_and_place-Cup-None-Cabinet-2/trial_T20190908_031003_719573/', '/train/pick_and_place_with_movable_recep-DishSponge-Plate-Cabinet-19/trial_T20190908_235802_391655/', '/train/pick_and_place_with_movable_recep-TomatoSliced-Plate-DiningTable-15/trial_T20190918_195819_356289/', '/train/pick_and_place_with_movable_recep-Pencil-Bowl-SideTable-316/trial_T20190909_135229_925643/', '/train/pick_clean_then_place_in_recep-SoapBar-None-Toilet-419/trial_T20190907_005338_967686/', '/train/pick_and_place_with_movable_recep-Knife-Pan-DiningTable-15/trial_T20190908_062224_926815/', '/train/pick_heat_then_place_in_recep-TomatoSliced-None-CounterTop-25/trial_T20190909_051237_496411/', '/train/pick_heat_then_place_in_recep-BreadSliced-None-GarbageCan-2/trial_T20190908_105926_372842/', '/train/pick_and_place_with_movable_recep-DishSponge-Plate-DiningTable-11/trial_T20190906_212530_423925/', '/train/pick_clean_then_place_in_recep-Cloth-None-Cart-401/trial_T20190907_045451_101032/', '/valid_seen/pick_clean_then_place_in_recep-DishSponge-None-Cart-401/trial_T20190907_024634_972453/', '/train/look_at_obj_in_light-RemoteControl-None-FloorLamp-220/trial_T20190908_004633_687279/', '/train/pick_and_place_with_movable_recep-ButterKnife-Cup-CounterTop-23/trial_T20190907_103742_831880/', '/train/pick_clean_then_place_in_recep-Kettle-None-DiningTable-18/trial_T20190908_085532_288859/', '/train/pick_and_place_with_movable_recep-Pencil-Mug-Desk-303/trial_T20190909_113818_290275/', '/train/pick_cool_then_place_in_recep-Mug-None-CoffeeMachine-25/trial_T20190908_114709_114615/', '/train/pick_and_place_with_movable_recep-Apple-Pot-Fridge-26/trial_T20190908_163604_866361/', '/train/pick_cool_then_place_in_recep-Egg-None-CounterTop-27/trial_T20190909_002015_890646/', '/train/pick_clean_then_place_in_recep-SoapBar-None-GarbageCan-403/trial_T20190909_080111_999655/', '/train/pick_and_place_simple-ToiletPaper-None-Toilet-419/trial_T20190908_002414_710612/', '/train/pick_cool_then_place_in_recep-Bowl-None-SinkBasin-18/trial_T20190909_034849_860090/', '/train/pick_and_place_simple-Cloth-None-Cart-401/trial_T20190909_054522_876529/', '/train/look_at_obj_in_light-Laptop-None-FloorLamp-225/trial_T20190906_213134_217016/', '/train/pick_two_obj_and_place-Pillow-None-Ottoman-208/trial_T20190908_091434_545645/', '/train/pick_two_obj_and_place-SaltShaker-None-CounterTop-25/trial_T20190908_084327_300026/', '/train/pick_heat_then_place_in_recep-BreadSliced-None-DiningTable-27/trial_T20190908_180243_716753/', '/train/pick_clean_then_place_in_recep-ButterKnife-None-DiningTable-16/trial_T20190909_114540_128185/', '/train/pick_and_place_simple-CreditCard-None-CoffeeTable-217/trial_T20190909_135734_881357/', '/train/pick_and_place_with_movable_recep-CD-Bowl-SideTable-330/trial_T20190907_223640_035743/', '/train/pick_and_place_simple-HandTowel-None-CounterTop-421/trial_T20190909_145525_802579/', '/train/pick_two_obj_and_place-AlarmClock-None-Desk-313/trial_T20190909_054541_175663/', '/train/pick_and_place_simple-SoapBottle-None-Cabinet-417/trial_T20190910_084726_610116/', '/train/pick_clean_then_place_in_recep-Potato-None-GarbageCan-19/trial_T20190908_073719_353393/', '/train/pick_cool_then_place_in_recep-Potato-None-Microwave-13/trial_T20190911_231120_340419/', '/train/pick_two_obj_and_place-Watch-None-Dresser-301/trial_T20190906_180154_425245/', '/train/pick_and_place_simple-SprayBottle-None-Toilet-420/trial_T20190909_113828_525912/', '/train/pick_two_obj_and_place-Newspaper-None-Drawer-224/trial_T20190911_101119_501414/', '/train/pick_and_place_simple-Candle-None-CounterTop-411/trial_T20190906_200812_843662/', '/train/pick_two_obj_and_place-Candle-None-CounterTop-402/trial_T20190909_082550_953024/', '/valid_unseen/pick_heat_then_place_in_recep-AppleSliced-None-GarbageCan-10/trial_T20190908_073656_715770/', '/train/pick_and_place_with_movable_recep-Pencil-Bowl-CoffeeTable-201/trial_T20190913_034405_409538/', '/valid_unseen/pick_and_place_with_movable_recep-Spoon-Mug-CounterTop-10/trial_T20190907_155134_457504/', '/train/pick_and_place_simple-AppleSliced-None-Microwave-14/trial_T20190908_171329_509999/', '/train/pick_two_obj_and_place-SoapBar-None-BathtubBasin-405/trial_T20190909_003121_739638/', '/valid_unseen/pick_two_obj_and_place-AppleSliced-None-CounterTop-10/trial_T20190907_061009_396474/', '/train/pick_heat_then_place_in_recep-Egg-None-CounterTop-30/trial_T20190909_130447_271507/', '/valid_seen/pick_clean_then_place_in_recep-Cloth-None-Toilet-413/trial_T20190908_175253_104175/', '/train/pick_heat_then_place_in_recep-BreadSliced-None-CounterTop-4/trial_T20190909_021644_891574/', '/train/pick_cool_then_place_in_recep-Bowl-None-DiningTable-23/trial_T20190908_140343_327191/', '/valid_seen/pick_and_place_simple-Book-None-SideTable-329/trial_T20190908_050633_745514/', '/train/pick_heat_then_place_in_recep-Potato-None-CounterTop-19/trial_T20190909_152050_792044/', '/train/pick_clean_then_place_in_recep-SoapBar-None-BathtubBasin-405/trial_T20190906_212829_931361/', '/train/pick_two_obj_and_place-Lettuce-None-Fridge-27/trial_T20190907_212146_772205/', '/train/pick_two_obj_and_place-SoapBottle-None-Cabinet-406/trial_T20190909_145544_288730/', '/train/pick_heat_then_place_in_recep-TomatoSliced-None-SinkBasin-4/trial_T20190909_065127_733545/', '/train/pick_heat_then_place_in_recep-TomatoSliced-None-DiningTable-17/trial_T20190908_130549_992332/', '/train/pick_two_obj_and_place-Kettle-None-DiningTable-18/trial_T20190906_233847_462015/', '/train/pick_cool_then_place_in_recep-Pan-None-DiningTable-11/trial_T20190908_204315_625279/', '/train/pick_and_place_with_movable_recep-Knife-Mug-SinkBasin-2/trial_T20190908_042046_215071/', '/train/pick_two_obj_and_place-Pen-None-GarbageCan-321/trial_T20190907_201828_429337/', '/train/look_at_obj_in_light-TennisRacket-None-DeskLamp-303/trial_T20190907_165321_540209/', '/train/pick_cool_then_place_in_recep-Apple-None-Microwave-12/trial_T20190911_003046_688848/', '/train/pick_cool_then_place_in_recep-Potato-None-Microwave-15/trial_T20190908_154425_762831/', '/train/pick_and_place_with_movable_recep-Pen-Mug-Dresser-303/trial_T20190907_020734_453750/', '/train/pick_two_obj_and_place-Lettuce-None-SinkBasin-18/trial_T20190908_022322_166452/', '/train/pick_heat_then_place_in_recep-Plate-None-DiningTable-7/trial_T20190907_223726_407992/', '/train/pick_and_place_simple-HandTowel-None-GarbageCan-423/trial_T20190907_030014_861239/', '/train/pick_two_obj_and_place-Newspaper-None-CoffeeTable-222/trial_T20190908_205540_806550/', '/train/pick_heat_then_place_in_recep-Cup-None-Cabinet-30/trial_T20190906_200229_166300/', '/train/pick_and_place_with_movable_recep-Spatula-Pot-DiningTable-11/trial_T20190907_061258_788114/', '/train/pick_clean_then_place_in_recep-Pan-None-DiningTable-17/trial_T20190908_121048_245346/', '/train/pick_cool_then_place_in_recep-LettuceSliced-None-CounterTop-1/trial_T20190909_153325_717118/', '/train/pick_two_obj_and_place-CreditCard-None-Sofa-216/trial_T20190909_150017_974673/', '/train/pick_and_place_with_movable_recep-Spoon-Mug-CounterTop-16/trial_T20190918_175532_761776/', '/train/pick_two_obj_and_place-CreditCard-None-Drawer-213/trial_T20190909_020235_777494/', '/train/pick_and_place_simple-Kettle-None-Shelf-1/trial_T20190907_011728_518941/', '/train/pick_clean_then_place_in_recep-Pot-None-StoveBurner-4/trial_T20190907_151406_550745/', '/train/pick_heat_then_place_in_recep-Cup-None-Fridge-13/trial_T20190908_070533_944479/', '/train/pick_and_place_simple-KeyChain-None-Sofa-229/trial_T20190908_123359_988104/', '/train/pick_and_place_simple-Candle-None-Toilet-429/trial_T20190908_052308_217335/', '/train/pick_and_place_with_movable_recep-Pen-Mug-Dresser-301/trial_T20190909_022706_734543/', '/valid_unseen/pick_and_place_with_movable_recep-Glassbottle-Plate-SinkBasin-10/trial_T20190908_123311_648354/', '/train/pick_two_obj_and_place-SoapBar-None-Drawer-420/trial_T20190908_124733_053705/', '/train/pick_heat_then_place_in_recep-Potato-None-Fridge-19/trial_T20190907_235540_283485/', '/train/pick_cool_then_place_in_recep-Pan-None-DiningTable-15/trial_T20190909_003904_518800/', '/train/pick_and_place_simple-CD-None-SideTable-328/trial_T20190907_033509_300729/', '/train/pick_two_obj_and_place-HandTowel-None-Toilet-409/trial_T20190909_054134_111298/', '/train/pick_clean_then_place_in_recep-Mug-None-CoffeeMachine-1/trial_T20190909_134634_406636/', '/train/pick_cool_then_place_in_recep-Bread-None-CounterTop-11/trial_T20190907_185214_077230/', '/train/look_at_obj_in_light-Laptop-None-DeskLamp-328/trial_T20190908_201601_178214/', '/train/pick_two_obj_and_place-RemoteControl-None-CoffeeTable-227/trial_T20190909_011214_257663/', '/train/look_at_obj_in_light-KeyChain-None-FloorLamp-227/trial_T20190908_170525_472933/', '/train/pick_and_place_simple-TennisRacket-None-Dresser-324/trial_T20190908_031758_208825/', '/train/pick_and_place_simple-KeyChain-None-Desk-310/trial_T20190908_124631_281710/', '/train/look_at_obj_in_light-CreditCard-None-FloorLamp-209/trial_T20190907_212014_137982/', '/valid_seen/pick_two_obj_and_place-CD-None-Drawer-304/trial_T20190907_230232_832893/', '/train/pick_clean_then_place_in_recep-SoapBar-None-BathtubBasin-426/trial_T20190908_180058_948165/', '/train/pick_and_place_with_movable_recep-KeyChain-Plate-Shelf-214/trial_T20190908_221328_135625/', '/valid_unseen/pick_heat_then_place_in_recep-Tomato-None-GarbageCan-10/trial_T20190908_225046_020282/', '/train/pick_heat_then_place_in_recep-PotatoSliced-None-Fridge-6/trial_T20190907_214020_312152/', '/train/pick_two_obj_and_place-ToiletPaper-None-Cabinet-414/trial_T20190909_090515_748255/', '/train/pick_and_place_simple-TomatoSliced-None-SideTable-3/trial_T20190908_091633_587949/', '/train/pick_and_place_simple-HandTowel-None-BathtubBasin-422/trial_T20190907_182556_512819/', '/train/pick_two_obj_and_place-RemoteControl-None-CoffeeTable-222/trial_T20190909_060946_246253/', '/train/pick_clean_then_place_in_recep-LettuceSliced-None-SideTable-3/trial_T20190907_181630_356618/', '/valid_unseen/pick_two_obj_and_place-KeyChain-None-Safe-219/trial_T20190909_011850_153676/', '/train/look_at_obj_in_light-Laptop-None-DeskLamp-306/trial_T20190908_105734_354331/', '/train/pick_and_place_simple-ToiletPaper-None-ToiletPaperHanger-412/trial_T20190907_181227_790902/', '/train/pick_two_obj_and_place-Spoon-None-SideTable-3/trial_T20190908_123227_411282/', '/train/pick_clean_then_place_in_recep-DishSponge-None-Drawer-427/trial_T20190909_001435_061244/', '/train/pick_two_obj_and_place-CreditCard-None-CoffeeTable-217/trial_T20190911_185442_429428/', '/train/pick_two_obj_and_place-Candle-None-Shelf-429/trial_T20190909_075128_271977/', '/train/pick_cool_then_place_in_recep-Lettuce-None-GarbageCan-17/trial_T20190907_114546_602779/', '/train/pick_heat_then_place_in_recep-BreadSliced-None-GarbageCan-4/trial_T20190908_050526_403658/', '/train/pick_clean_then_place_in_recep-Pot-None-Fridge-4/trial_T20190908_153033_044700/', '/train/look_at_obj_in_light-TennisRacket-None-DeskLamp-318/trial_T20190907_004013_824414/', '/train/pick_heat_then_place_in_recep-Potato-None-SideTable-3/trial_T20190909_050408_729839/', '/train/pick_two_obj_and_place-CellPhone-None-Safe-302/trial_T20190909_043337_021738/', '/train/pick_and_place_with_movable_recep-Spatula-Bowl-DiningTable-16/trial_T20190918_182344_396080/', '/train/pick_clean_then_place_in_recep-Ladle-None-Cabinet-8/trial_T20190908_005649_247429/', '/train/pick_and_place_with_movable_recep-CellPhone-Bowl-Desk-305/trial_T20190909_181955_696983/', '/train/pick_two_obj_and_place-Statue-None-SideTable-214/trial_T20190909_065635_751813/', '/train/pick_cool_then_place_in_recep-TomatoSliced-None-GarbageCan-16/trial_T20190907_204345_813064/', '/valid_unseen/pick_cool_then_place_in_recep-LettuceSliced-None-GarbageCan-10/trial_T20190908_204424_983859/', '/train/pick_two_obj_and_place-SprayBottle-None-GarbageCan-418/trial_T20190909_051110_474114/', '/train/pick_heat_then_place_in_recep-Tomato-None-Fridge-14/trial_T20190908_091707_240737/', '/train/pick_heat_then_place_in_recep-Cup-None-Fridge-22/trial_T20190908_072702_772430/', '/train/pick_clean_then_place_in_recep-Kettle-None-Cabinet-11/trial_T20190908_063358_779789/', '/train/pick_heat_then_place_in_recep-AppleSliced-None-SinkBasin-18/trial_T20190909_005603_590931/', '/train/pick_cool_then_place_in_recep-BreadSliced-None-DiningTable-15/trial_T20190909_021554_837955/', '/valid_seen/pick_clean_then_place_in_recep-Lettuce-None-CounterTop-16/trial_T20190909_051630_092360/', '/train/pick_two_obj_and_place-SoapBottle-None-Cabinet-406/trial_T20190909_145606_701162/', '/train/pick_clean_then_place_in_recep-TomatoSliced-None-CounterTop-25/trial_T20190909_065535_805000/', '/train/pick_cool_then_place_in_recep-Cup-None-Cabinet-12/trial_T20190909_102717_341286/', '/train/pick_two_obj_and_place-Candle-None-Shelf-422/trial_T20190910_133316_548729/', '/train/pick_two_obj_and_place-Watch-None-Shelf-326/trial_T20190911_150057_341885/', '/train/pick_and_place_simple-Pen-None-SideTable-309/trial_T20190907_051843_166835/', '/train/pick_cool_then_place_in_recep-Pot-None-StoveBurner-23/trial_T20190907_150154_814362/', '/train/pick_clean_then_place_in_recep-SoapBar-None-Cabinet-403/trial_T20190906_161856_202281/', '/train/pick_cool_then_place_in_recep-Cup-None-SinkBasin-30/trial_T20190909_012346_009926/', '/train/pick_two_obj_and_place-Book-None-Dresser-317/trial_T20190910_180514_095493/', '/train/pick_heat_then_place_in_recep-BreadSliced-None-Fridge-2/trial_T20190909_075013_874186/', '/train/pick_cool_then_place_in_recep-AppleSliced-None-Microwave-25/trial_T20190908_055249_478388/', '/train/pick_clean_then_place_in_recep-Cloth-None-Toilet-407/trial_T20190907_022153_466691/', '/train/pick_and_place_with_movable_recep-DishSponge-Pan-DiningTable-16/trial_T20190909_032640_044586/', '/train/pick_cool_then_place_in_recep-LettuceSliced-None-GarbageCan-20/trial_T20190909_125202_088056/', '/train/pick_two_obj_and_place-DishSponge-None-Toilet-403/trial_T20190908_024917_909971/', '/train/pick_cool_then_place_in_recep-Potato-None-GarbageCan-17/trial_T20190908_204151_818156/', '/train/pick_two_obj_and_place-KeyChain-None-ArmChair-222/trial_T20190909_100237_670347/', '/train/pick_cool_then_place_in_recep-Pot-None-CounterTop-5/trial_T20190908_073249_042493/', '/valid_seen/pick_cool_then_place_in_recep-Cup-None-SinkBasin-19/trial_T20190906_195826_107019/', '/train/pick_two_obj_and_place-Candle-None-Toilet-417/trial_T20190907_182724_868283/', '/train/pick_two_obj_and_place-ToiletPaper-None-CounterTop-417/trial_T20190906_224412_871995/', '/train/pick_cool_then_place_in_recep-Pot-None-CounterTop-5/trial_T20190908_073403_352600/', '/train/pick_two_obj_and_place-SoapBar-None-BathtubBasin-419/trial_T20190906_201450_776879/', '/train/pick_and_place_with_movable_recep-Pen-Bowl-Desk-327/trial_T20190907_020501_280258/', '/valid_seen/pick_cool_then_place_in_recep-Tomato-None-GarbageCan-6/trial_T20190909_082934_483899/', '/train/pick_clean_then_place_in_recep-Lettuce-None-Fridge-19/trial_T20190908_100102_253901/', '/train/pick_cool_then_place_in_recep-Apple-None-CounterTop-27/trial_T20190909_083707_707683/', '/train/pick_heat_then_place_in_recep-Egg-None-SideTable-28/trial_T20190908_115607_419115/', '/train/pick_two_obj_and_place-KeyChain-None-Safe-204/trial_T20190906_190057_223109/', '/train/pick_two_obj_and_place-Pencil-None-Desk-303/trial_T20190908_220314_534721/', '/train/pick_and_place_with_movable_recep-TomatoSliced-Pan-DiningTable-18/trial_T20190908_073040_181233/', '/train/pick_two_obj_and_place-Pillow-None-ArmChair-321/trial_T20190907_121735_217785/', '/train/pick_two_obj_and_place-KeyChain-None-ArmChair-217/trial_T20190906_213318_485668/', '/train/pick_heat_then_place_in_recep-TomatoSliced-None-GarbageCan-25/trial_T20190910_152759_264561/', '/train/pick_clean_then_place_in_recep-Spoon-None-DiningTable-20/trial_T20190909_034736_199541/', '/train/pick_two_obj_and_place-SprayBottle-None-GarbageCan-418/trial_T20190909_071739_357749/', '/valid_seen/pick_two_obj_and_place-SoapBar-None-Toilet-412/trial_T20190908_071602_531614/', '/train/pick_two_obj_and_place-Pencil-None-Drawer-327/trial_T20190918_171204_045094/', '/train/pick_two_obj_and_place-Pencil-None-Desk-314/trial_T20190907_045011_990789/', '/train/pick_cool_then_place_in_recep-Bowl-None-Cabinet-25/trial_T20190908_073356_031859/', '/train/pick_two_obj_and_place-KeyChain-None-Dresser-330/trial_T20190908_135832_399583/', '/train/pick_and_place_with_movable_recep-TomatoSliced-Pot-DiningTable-11/trial_T20190907_033937_316061/', '/valid_seen/pick_heat_then_place_in_recep-Tomato-None-DiningTable-16/trial_T20190907_201243_698086/', '/valid_unseen/pick_heat_then_place_in_recep-Apple-None-Fridge-10/trial_T20190906_182353_418140/', '/train/pick_and_place_with_movable_recep-Pencil-Plate-CoffeeTable-203/trial_T20190907_211333_922716/', '/train/pick_two_obj_and_place-BreadSliced-None-Fridge-11/trial_T20190908_132230_515563/', '/train/pick_and_place_simple-Watch-None-CoffeeTable-201/trial_T20190908_124638_700872/', '/train/look_at_obj_in_light-Statue-None-FloorLamp-211/trial_T20190908_071322_816243/', '/train/pick_cool_then_place_in_recep-AppleSliced-None-Microwave-14/trial_T20190908_015239_858947/', '/train/pick_heat_then_place_in_recep-Tomato-None-Fridge-15/trial_T20190909_020250_544216/', '/train/pick_heat_then_place_in_recep-Cup-None-Shelf-1/trial_T20190906_230051_015449/', '/train/pick_two_obj_and_place-SprayBottle-None-GarbageCan-418/trial_T20190909_071533_543818/', '/train/pick_cool_then_place_in_recep-WineBottle-None-Cabinet-16/trial_T20190907_084141_322809/', '/train/pick_heat_then_place_in_recep-BreadSliced-None-SideTable-28/trial_T20190907_180304_503402/', '/train/pick_cool_then_place_in_recep-PotatoSliced-None-Microwave-2/trial_T20190909_094705_346689/', '/train/pick_clean_then_place_in_recep-TomatoSliced-None-Microwave-30/trial_T20190908_225945_581819/', '/train/pick_heat_then_place_in_recep-TomatoSliced-None-Fridge-14/trial_T20190911_114912_806806/', '/valid_unseen/pick_clean_then_place_in_recep-Egg-None-Microwave-10/trial_T20190909_120554_888709/', '/train/pick_two_obj_and_place-Cup-None-CounterTop-4/trial_T20190908_095244_390748/', '/train/pick_cool_then_place_in_recep-Apple-None-Microwave-23/trial_T20190908_051030_481119/', '/train/pick_and_place_with_movable_recep-Spoon-Mug-SideTable-21/trial_T20190906_214227_238692/', '/train/pick_and_place_with_movable_recep-Fork-Cup-DiningTable-26/trial_T20190907_043526_089725/', '/valid_unseen/pick_and_place_with_movable_recep-ButterKnife-Cup-CounterTop-10/trial_T20190909_000045_648853/', '/train/pick_and_place_with_movable_recep-Fork-Mug-SinkBasin-18/trial_T20190909_043700_281076/', '/valid_unseen/pick_clean_then_place_in_recep-LettuceSliced-None-GarbageCan-10/trial_T20190918_143430_997524/', '/train/pick_clean_then_place_in_recep-Spatula-None-DiningTable-19/trial_T20190909_081145_746450/', '/train/pick_clean_then_place_in_recep-SoapBar-None-BathtubBasin-419/trial_T20190907_133059_162744/', '/train/pick_clean_then_place_in_recep-Cloth-None-Toilet-411/trial_T20190908_070040_227185/', '/train/pick_cool_then_place_in_recep-Lettuce-None-CounterTop-22/trial_T20190908_084626_474201/', '/train/pick_and_place_with_movable_recep-DishSponge-Plate-Cabinet-1/trial_T20190909_055218_416616/', '/train/pick_heat_then_place_in_recep-BreadSliced-None-Fridge-24/trial_T20190909_072551_926499/', '/train/pick_cool_then_place_in_recep-Pan-None-StoveBurner-16/trial_T20190907_164753_746972/', '/train/pick_cool_then_place_in_recep-Plate-None-DiningTable-23/trial_T20190910_025008_561989/', '/train/pick_two_obj_and_place-ToiletPaper-None-CounterTop-417/trial_T20190906_224516_486826/', '/train/pick_cool_then_place_in_recep-BreadSliced-None-Microwave-16/trial_T20190908_040222_595258/', '/train/pick_two_obj_and_place-SoapBottle-None-GarbageCan-416/trial_T20190909_003119_083823/', '/train/pick_heat_then_place_in_recep-BreadSliced-None-Fridge-6/trial_T20190909_132728_647569/', '/train/pick_cool_then_place_in_recep-BreadSliced-None-DiningTable-24/trial_T20190909_000536_618843/', '/train/pick_heat_then_place_in_recep-Cup-None-Cabinet-8/trial_T20190907_170522_408193/', '/train/pick_cool_then_place_in_recep-Mug-None-CoffeeMachine-19/trial_T20190907_162039_724874/', '/train/pick_heat_then_place_in_recep-BreadSliced-None-Fridge-6/trial_T20190909_132444_325849/', '/train/pick_clean_then_place_in_recep-TomatoSliced-None-SideTable-3/trial_T20190908_233534_790055/', '/train/pick_cool_then_place_in_recep-BreadSliced-None-GarbageCan-30/trial_T20190909_064438_485909/', '/train/pick_cool_then_place_in_recep-Apple-None-SinkBasin-11/trial_T20190909_072142_023384/', '/train/look_at_obj_in_light-TissueBox-None-FloorLamp-225/trial_T20190907_150757_717098/', '/train/pick_cool_then_place_in_recep-Pan-None-DiningTable-15/trial_T20190909_004008_377860/', '/train/pick_heat_then_place_in_recep-BreadSliced-None-DiningTable-7/trial_T20190906_200354_715647/', '/train/pick_heat_then_place_in_recep-AppleSliced-None-Fridge-27/trial_T20190909_060505_162941/', '/valid_unseen/pick_two_obj_and_place-SoapBar-None-GarbageCan-424/trial_T20190909_064309_357168/', '/train/pick_cool_then_place_in_recep-Cup-None-Shelf-7/trial_T20190906_222229_326451/', '/train/pick_cool_then_place_in_recep-Apple-None-GarbageCan-2/trial_T20190906_195910_686523/', '/train/pick_clean_then_place_in_recep-SoapBar-None-BathtubBasin-426/trial_T20190908_052251_559452/', '/train/pick_cool_then_place_in_recep-Cup-None-Microwave-30/trial_T20190909_073542_933715/', '/train/pick_two_obj_and_place-PotatoSliced-None-GarbageCan-28/trial_T20190908_115202_678384/', '/train/pick_two_obj_and_place-SoapBottle-None-Cabinet-417/trial_T20190906_192320_630856/', '/train/pick_clean_then_place_in_recep-AppleSliced-None-GarbageCan-6/trial_T20190908_121813_388991/', '/train/pick_cool_then_place_in_recep-Bowl-None-CounterTop-17/trial_T20190909_042203_048291/', '/train/pick_heat_then_place_in_recep-AppleSliced-None-GarbageCan-20/trial_T20190910_093053_767343/', '/train/pick_two_obj_and_place-Tomato-None-CounterTop-19/trial_T20190907_144603_396680/', '/train/pick_cool_then_place_in_recep-Potato-None-SinkBasin-24/trial_T20190909_052052_885855/', '/train/pick_cool_then_place_in_recep-Mug-None-CoffeeMachine-23/trial_T20190908_035419_625837/', '/train/pick_two_obj_and_place-CreditCard-None-ArmChair-221/trial_T20190907_161543_309705/', '/train/pick_and_place_with_movable_recep-Watch-Box-DiningTable-228/trial_T20190908_143600_918787/', '/train/pick_cool_then_place_in_recep-Egg-None-CounterTop-12/trial_T20190907_151655_070309/', '/train/pick_cool_then_place_in_recep-Pot-None-CounterTop-1/trial_T20190909_124252_504581/', '/train/pick_clean_then_place_in_recep-Apple-None-Microwave-24/trial_T20190907_133121_308801/', '/valid_seen/pick_cool_then_place_in_recep-Tomato-None-CounterTop-12/trial_T20190909_063844_274181/', '/train/pick_heat_then_place_in_recep-Potato-None-CounterTop-19/trial_T20190909_152158_373637/', '/train/pick_two_obj_and_place-AlarmClock-None-Dresser-318/trial_T20190919_024636_931517/', '/train/pick_two_obj_and_place-ToiletPaper-None-Cabinet-412/trial_T20190908_141627_482177/', '/train/pick_heat_then_place_in_recep-Potato-None-SinkBasin-18/trial_T20190909_050557_136157/', '/train/pick_cool_then_place_in_recep-Pot-None-Shelf-7/trial_T20190907_024924_873513/', '/train/pick_heat_then_place_in_recep-Mug-None-CoffeeMachine-15/trial_T20190908_004759_413623/', '/train/pick_two_obj_and_place-CreditCard-None-ArmChair-227/trial_T20190907_075752_838584/', '/train/pick_and_place_with_movable_recep-LettuceSliced-Pot-DiningTable-21/trial_T20190907_160450_284801/', '/train/pick_heat_then_place_in_recep-Egg-None-GarbageCan-2/trial_T20190909_101236_908258/', '/train/pick_two_obj_and_place-SprayBottle-None-GarbageCan-419/trial_T20190908_164331_451441/', '/train/pick_two_obj_and_place-PepperShaker-None-Cabinet-8/trial_T20190912_115403_916426/', '/train/pick_and_place_with_movable_recep-Fork-Mug-SinkBasin-18/trial_T20190909_043619_178475/', '/train/pick_heat_then_place_in_recep-Potato-None-DiningTable-11/trial_T20190909_101238_901434/', '/train/pick_two_obj_and_place-Book-None-Dresser-324/trial_T20190908_085544_633388/', '/train/pick_two_obj_and_place-SoapBottle-None-Toilet-428/trial_T20190909_070317_650884/', '/train/pick_cool_then_place_in_recep-Potato-None-Microwave-18/trial_T20190909_151853_245524/', '/train/pick_clean_then_place_in_recep-Ladle-None-Cabinet-2/trial_T20190908_220613_638553/', '/valid_seen/pick_heat_then_place_in_recep-AppleSliced-None-Fridge-18/trial_T20190911_045200_839773/', '/train/pick_heat_then_place_in_recep-Mug-None-CoffeeMachine-16/trial_T20190908_181242_051846/', '/train/pick_heat_then_place_in_recep-PotatoSliced-None-SinkBasin-23/trial_T20190907_123248_978930/', '/train/pick_cool_then_place_in_recep-Pot-None-DiningTable-27/trial_T20190909_013436_602388/', '/train/pick_cool_then_place_in_recep-PotatoSliced-None-CounterTop-20/trial_T20190909_130052_715881/', '/train/pick_heat_then_place_in_recep-Egg-None-Fridge-19/trial_T20190908_130410_448245/', '/train/pick_clean_then_place_in_recep-LettuceSliced-None-CounterTop-6/trial_T20190908_054136_289177/', '/train/pick_heat_then_place_in_recep-Mug-None-CoffeeMachine-6/trial_T20190906_214114_913196/', '/train/pick_heat_then_place_in_recep-PotatoSliced-None-SinkBasin-1/trial_T20190909_120614_295479/', '/train/pick_heat_then_place_in_recep-Apple-None-Fridge-6/trial_T20190908_153716_620298/', '/train/pick_two_obj_and_place-RemoteControl-None-CoffeeTable-222/trial_T20190909_060926_764421/', '/train/pick_two_obj_and_place-Candle-None-CounterTop-406/trial_T20190908_045930_816994/', '/train/pick_clean_then_place_in_recep-DishSponge-None-BathtubBasin-427/trial_T20190906_234820_863494/', '/train/pick_clean_then_place_in_recep-TomatoSliced-None-Microwave-20/trial_T20190906_200120_945716/', '/train/pick_heat_then_place_in_recep-AppleSliced-None-DiningTable-18/trial_T20190908_204024_506453/', '/train/pick_and_place_with_movable_recep-TomatoSliced-Plate-Fridge-23/trial_T20190919_023729_620532/', '/train/pick_cool_then_place_in_recep-PotatoSliced-None-Microwave-5/trial_T20190914_020559_534073/', '/train/pick_two_obj_and_place-ToiletPaper-None-Cabinet-408/trial_T20190909_085658_782847/', '/train/pick_two_obj_and_place-RemoteControl-None-ArmChair-214/trial_T20190909_011022_706846/', '/train/pick_heat_then_place_in_recep-TomatoSliced-None-SinkBasin-13/trial_T20190908_044241_267982/', '/train/pick_cool_then_place_in_recep-Bowl-None-Cabinet-2/trial_T20190907_021058_144729/', '/train/pick_heat_then_place_in_recep-PotatoSliced-None-CounterTop-12/trial_T20190908_015116_748316/', '/train/pick_heat_then_place_in_recep-AppleSliced-None-SinkBasin-18/trial_T20190909_005416_652080/', '/train/pick_two_obj_and_place-SoapBar-None-SinkBasin-420/trial_T20190908_182137_274041/', '/train/pick_cool_then_place_in_recep-Tomato-None-DiningTable-26/trial_T20190907_160916_014285/', '/train/pick_and_place_simple-Watch-None-DiningTable-326/trial_T20190908_132712_949739/', '/train/pick_cool_then_place_in_recep-Egg-None-Microwave-12/trial_T20190911_170056_532427/', '/train/pick_heat_then_place_in_recep-Tomato-None-SinkBasin-3/trial_T20190909_004608_186817/', '/train/pick_heat_then_place_in_recep-Tomato-None-Fridge-12/trial_T20190906_190441_327141/', '/train/pick_cool_then_place_in_recep-WineBottle-None-Cabinet-17/trial_T20190907_064115_485667/', '/train/pick_cool_then_place_in_recep-TomatoSliced-None-Microwave-27/trial_T20190908_102220_103784/', '/valid_unseen/pick_two_obj_and_place-PepperShaker-None-Drawer-10/trial_T20190908_010306_215435/', '/train/pick_heat_then_place_in_recep-PotatoSliced-None-GarbageCan-25/trial_T20190911_111331_813770/', '/train/pick_and_place_with_movable_recep-Spatula-Pan-CounterTop-13/trial_T20190908_194356_142266/', '/train/pick_heat_then_place_in_recep-AppleSliced-None-SinkBasin-20/trial_T20190909_044620_454567/', '/train/pick_and_place_with_movable_recep-AppleSliced-Plate-DiningTable-19/trial_T20190918_203344_481937/', '/train/pick_cool_then_place_in_recep-Lettuce-None-DiningTable-15/trial_T20190909_040930_741345/', '/train/pick_cool_then_place_in_recep-Bowl-None-Shelf-5/trial_T20190908_083645_361274/', '/train/pick_clean_then_place_in_recep-DishSponge-None-Cart-430/trial_T20190906_233458_108018/', '/train/pick_heat_then_place_in_recep-Egg-None-GarbageCan-23/trial_T20190911_011457_072067/', '/train/pick_two_obj_and_place-Ladle-None-Drawer-4/trial_T20190908_154838_594672/', '/train/pick_two_obj_and_place-HandTowel-None-SinkBasin-412/trial_T20190908_065036_619246/', '/train/pick_heat_then_place_in_recep-PotatoSliced-None-Fridge-15/trial_T20190908_123948_977173/', '/train/pick_clean_then_place_in_recep-DishSponge-None-Cart-430/trial_T20190906_233529_080163/', '/train/pick_two_obj_and_place-ToiletPaper-None-Drawer-410/trial_T20190908_111427_862927/', '/train/pick_clean_then_place_in_recep-SoapBar-None-GarbageCan-420/trial_T20190906_201041_787997/', '/train/pick_heat_then_place_in_recep-Cup-None-Shelf-7/trial_T20190906_211214_598438/', '/train/look_at_obj_in_light-KeyChain-None-FloorLamp-227/trial_T20190908_104128_972146/', '/train/pick_cool_then_place_in_recep-BreadSliced-None-CounterTop-12/trial_T20190907_163957_248730/', '/train/pick_and_place_with_movable_recep-Candle-Box-CoffeeTable-230/trial_T20190906_232417_947259/', '/train/pick_two_obj_and_place-Cloth-None-Toilet-420/trial_T20190909_114444_267023/', '/train/pick_two_obj_and_place-SoapBar-None-Toilet-412/trial_T20190908_071724_491033/', '/train/pick_and_place_with_movable_recep-TomatoSliced-Pot-Fridge-4/trial_T20190908_105930_596901/', '/train/pick_and_place_with_movable_recep-CellPhone-Bowl-Dresser-311/trial_T20190906_165605_913043/', '/train/pick_clean_then_place_in_recep-AppleSliced-None-Fridge-23/trial_T20190918_153908_246159/', '/train/look_at_obj_in_light-KeyChain-None-FloorLamp-224/trial_T20190909_022603_989293/', '/train/pick_and_place_with_movable_recep-PotatoSliced-Pan-Fridge-27/trial_T20190908_035053_864434/', '/train/look_at_obj_in_light-Candle-None-FloorLamp-223/trial_T20190907_061753_998965/', '/train/pick_cool_then_place_in_recep-LettuceSliced-None-DiningTable-17/trial_T20190909_070753_890452/', '/train/pick_cool_then_place_in_recep-Lettuce-None-SinkBasin-4/trial_T20190907_142249_346119/', '/train/pick_cool_then_place_in_recep-Egg-None-SinkBasin-25/trial_T20190909_105123_819114/', '/train/pick_clean_then_place_in_recep-SoapBar-None-CounterTop-416/trial_T20190909_032310_871218/', '/train/pick_clean_then_place_in_recep-LettuceSliced-None-Fridge-19/trial_T20190909_010330_401774/', '/train/pick_cool_then_place_in_recep-Tomato-None-SinkBasin-30/trial_T20190908_012041_749782/', '/train/pick_clean_then_place_in_recep-LettuceSliced-None-DiningTable-27/trial_T20190909_004448_795194/', '/train/pick_clean_then_place_in_recep-PotatoSliced-None-DiningTable-16/trial_T20190908_201151_855255/', '/train/pick_and_place_with_movable_recep-Pencil-Bowl-CoffeeTable-201/trial_T20190908_021332_546301/', '/train/pick_clean_then_place_in_recep-Cup-None-Shelf-1/trial_T20190909_151825_980574/', '/train/pick_cool_then_place_in_recep-AppleSliced-None-Microwave-6/trial_T20190909_151559_900961/', '/train/pick_cool_then_place_in_recep-Bread-None-CounterTop-17/trial_T20190907_151028_159967/', '/train/pick_two_obj_and_place-CreditCard-None-ArmChair-227/trial_T20190907_075635_674582/', '/train/pick_cool_then_place_in_recep-Plate-None-Shelf-1/trial_T20190908_012254_327150/', '/train/pick_heat_then_place_in_recep-Mug-None-CoffeeMachine-30/trial_T20190908_175003_052826/', '/train/pick_cool_then_place_in_recep-Mug-None-CoffeeMachine-2/trial_T20190907_044037_341047/', '/train/pick_heat_then_place_in_recep-Bread-None-DiningTable-15/trial_T20190907_030751_816698/', '/train/pick_heat_then_place_in_recep-Mug-None-CoffeeMachine-16/trial_T20190908_181157_270120/', '/train/pick_heat_then_place_in_recep-PotatoSliced-None-SideTable-28/trial_T20190906_212031_031197/', '/train/pick_two_obj_and_place-Candle-None-Cabinet-412/trial_T20190908_222933_552183/']
    for search in beskip:
    '''
    for search in ['/train', '/valid_seen', '/valid_unseen']:
    # for search in ['/train/pick_and_place_with_movable_recep-DishSponge-Plate-DiningTable-11/trial_T20190906_212530_423925/']:
        walk = os.walk(args.data + search)
        roots += [root for root, dirs, files in walk if os.path.basename(root) == main_search_img_folder]
    random.shuffle(roots)
    print("search len ", len(roots))
    for i, root in enumerate(roots):
        if os.path.basename(root) == main_search_img_folder:
            if not check_task_type_in(root, task_types):
                continue
            feat_img_dict = {}
            root = root.replace(main_search_img_folder, '')
            for img_folder, keyname in zip(args.img_folder.split(','), args.keyname.split(',')):
                root_img = os.path.join(root, img_folder)
                files = glob.glob(root_img + '/*.png') +\
                    glob.glob(root_img + '/*.jpg')
                fimages = sorted([f for f in files
                                  if (f.endswith('.png') or (f.endswith('.jpg')))])
                if len(fimages) > 0:
                    if args.skip_existing\
                    and os.path.isfile(os.path.join(root, args.str_save_ft_name))\
                    and os.stat(os.path.join(root, args.str_save_ft_name)).st_size>100:
                        print("skip_existing")
                        break
                    try:
                        print('{}'.format(root_img))
                        image_loader = Image.open if isinstance(fimages[0], str) else Image.fromarray
                        images = [image_loader(f).convert('RGB') for f in fimages]
                        feat = extractor.featurize(images, batch=args.batch, GAP_Pooling=True)
                        feat_img_dict[keyname] = feat.cpu()
                    except Exception as e:
                        print(e)
                        print("Skipping " + root_img)
                        skipped.append(root_img)
                        feat_img_dict = {}
                        break

                else:
                    print('empty; skipping {}'.format(root_img))
            if len(feat_img_dict):
                torch.save(feat_img_dict, os.path.join(root, args.str_save_ft_name))
                print("i: ", i)

    print("Skipped:")
    print(skipped)